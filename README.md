# 연구
대규모 언어 모델 학습 파이프라인의 텍스트 전처리를 위한 Near-Data Processing 플랫폼 설계 및 구현

본 연구에서는 분리형 스토리지 환경에서 대규모 데이터의 네트워크 이동을 최소화하고 스토리지 서버 측에서 BPE 토크나이제이션을 수행할 수 있는 SPDK(Storage Performance Development Kit) 기반의 근접 데이터 처리(Near-Data Processing) 플랫폼을 제안한다. 제안한 플랫폼의 유효성을 검증하기 위해 호스트 서버와 스토리지 서버에서의 처리 성능을 비교 실험하였으며, 그 결과 기존 호스트 기반 처리 방식 대비 네트워크 전송량을 52%, 전체 I/O 시간을 최대 약 25% 감소시키는 효과를 확인하였다.

<img width="1068" height="467" alt="image" src="https://github.com/user-attachments/assets/cd938afb-a564-48d3-b96c-74f890e98790" />

본 연구에서 주목한 점은 다음과 같다. 대규모 언어 모델(LLM)의 학습 토큰 수는 크게 증가하고 있다.
로컬 스토리지의 한계를 넘어서 확장성을 고려한 분리형 스토리지 환경에서는 위 이미지와 같이 종단간(Storage-GPU)간 경로가 길다는 점과 텍스트 전처리인 토크나이제이션이 병목이 되고 있다.
이러한 병목은 데이터 스톨(Data Stall)을 유발하기 때문에 LLM 학습 파이프라인에서 토크나이제이션을 오프라인으로 분리하기도 한다. 이러한 구조는 저장공간과 관리 복잡성의 문제점이 발생한다. 
본 연구에서는 이러한 연구들의 절충안으로 토크나이제이션을 스토리지 서버로 오프로딩하는 구조를 제안한다. 이러한 구조를 통해 호스트 CPU를 처리 경로에서 배제하고 데이터 이동에 가장 큰 비용이 드는 네트워크 경유를 줄인다.

# 영감
본 연구의 키워드는 Near-Data Processing이다. 키워드의 핵심은 데이터가 이동하는 대신, 연산 프로세스가 데이터 가까이 이동하는 것이다. 즉, 데이터가 이동하기 전 전처리되어 줄어든 데이터가 이동해야 한다.
그런 점에서 토크나이제이션이 그러한 특성이 있는지 분석이 필요했다. LLM 학습 파이프라인의 핵심 전처리인 BPE(Byte Pair Encoding) 토크나이제이션은 실제 인코딩 과정에서 입력 문자열은 먼저 UTF-8 바이트 시퀀스로 변환되고, 초기 바이트 단위 시퀀스에 대해 학습된 병합 규칙을 왼쪽에서 오른쪽으로 그리디(greedy)하게 반복 적용하여 더 큰 서브워드 단위로 결합된다. 

현대 LLM에서 사용되는 BPE 기반 어휘는 대체로 30,000~65,000 규모로 설계되므로, 이 과정에서 생성되는 토큰 정수 ID는 대부분 0~65,535 범위 내에 존재한다. 그럼에도 불구하고 일반적인 토크나이저 라이브러리와 딥러닝 프레임워크 구현은 단순성과 호환성을 이유로 토큰 ID를 4바이트 정수(int32)로 저장하는 경우가 많다. 본 연구에서는 이러한 관행에 주목하여, 인코딩된 토큰 ID 시퀀스를 유지한 상태에서 해당 시퀀스의 데이터 타입을 4바이트 정수에서 2바이트 정수(uint16)로 축소 변환(downcasting)함으로써 동일한 서브워드 시퀀스를 절반 크기의 버퍼로 표현한다. BPE 토크나이제이션을 스토리지 서버에서 수행하면서 토큰 ID를 uint16 형식으로 전송하면, 호스트로 전달되는 데이터는 압축된 정수 ID 시퀀스가 되어 네트워크 전송량을 줄일 수 있으며, 이는 Near-Data Processing 설계철학과 일치한다.

# 제안하는 아이디어
SPDK를 기반으로 플랫폼을 구성하였는데, SPDK라는 프레임워크 채용의 주목적은 사용자 공간에서 구현한 전처리 런타임과 연결하기 위해서이다. 사용자 공간에서 프로세스를 구현하면 기존 라이브러리와 커널 인터페이스를 활용하기 때문에 구현이 용이하다. 

<img width="813" height="309" alt="image" src="https://github.com/user-attachments/assets/259a1470-3139-4fc4-ba13-7aa2193d3001" />
제안하는 아이디어의 개요는 위와 같으며 자세한 아키텍트는 아래 그림에 설명된다. 

<img width="920" height="475" alt="image" src="https://github.com/user-attachments/assets/ea1674bc-fa6b-439a-a09d-ac1083476818" />
구현의 특징은 비동기적인 데이터 교환이다. 이는 SPDK 특징에서 기인한 것으로 SPDK는 폴링 기반 리액터(쓰레드)를 기반으로 동작하기 때문에
내부 로직에서 블로킹이 발생하면 안된다. 그러나 테스트결과 메시지 큐와 공유 메모리 기반 데이터 교환에서 리액터가 전부 관여하는 경우 블로킹이 발생하는 것을 확인하였다.
이를 방지하기 위해 별도의 폴러를 배치하여 I/O 완료 작업은 폴러에서 수행하여 부하를 줄였다.

